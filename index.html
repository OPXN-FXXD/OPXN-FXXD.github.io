<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OpenFeed â€” Secure MVP with Images</title>
<style>
body{max-width:900px;margin:20px auto;padding:16px;font-family:system-ui,sans-serif;line-height:1.4}
h1,h3{margin-bottom:8px}
input,textarea,button{font:inherit;padding:6px}
.card{border:1px solid #ccc;padding:12px;border-radius:8px;margin:12px 0}
.feed-list{display:flex;flex-wrap:wrap;gap:8px}
.feed-item{background:#f1f1f1;padding:6px 8px;border-radius:6px;border:1px solid #ddd;display:flex;align-items:center}
.posts{margin-top:12px;max-height:500px;overflow-y:auto;border:1px solid #ddd;padding:8px;border-radius:6px;background:#fafafa}
.post{padding:10px;border-bottom:1px dashed #ccc}
.meta{font-size:12px;color:#555;margin-bottom:4px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.flex{display:flex;gap:8px}
.right{margin-left:auto}
img.post-image{max-width:100%;margin-top:6px;border-radius:6px}
</style>
</head>
<body>
<header>
<h1>OpenFeed â€” MVP with Images</h1>
<p>Decentralized feed client with login, automatic updates and image support.</p>
</header>

<section class="card">
<h3>Feed Timeline</h3>
<div class="controls">
<button id="refresh">Refresh Now</button>
<div class="right">Posts: <span id="postCount">0</span></div>
</div>
<div class="posts" id="posts"></div>
</section>

<section class="card">
<h3>Login to Post</h3>
<input id="username" placeholder="Username" />
<input id="password" type="password" placeholder="Password" />
<button id="loginBtn">Login</button>
<p id="loginStatus" style="color:red;"></p>
</section>

<section class="card">
<h3>New Post</h3>
<textarea id="postText" rows="3" placeholder="Write your post..." disabled></textarea>
<input type="file" id="postImage" accept="image/*" disabled />
<div class="controls">
<button id="postBtn" disabled>Post</button>
<button id="exportBtn">Download feed.json</button>
</div>
</section>

<section class="card">
<h3>Example feed.json</h3>
<pre>{
  "username": "OPXN-FXXD",
  "password": "ODQ3NA==",
  "about": "OpenFeed Enthusiast",
  "posts": [
    {
      "id": "2025-10-29T12:00:00Z-1",
      "time": "2025-10-29T12:00:00Z",
      "text": "Hello world! My first OpenFeed post ðŸŽ‰",
      "image": ""
    }
  ]
}</pre>
</section>

<footer>
<p>To host: Create a GitHub repository named OPXN-FXXD.github.io, upload feed.json and index.html, enable GitHub Pages. Site URL: https://OPXN-FXXD.github.io</p>
</footer>

<script>
// --- Config ---
const FEED_URL = "https://OPXN-FXXD.github.io/feed.json";
let feedData = null;
let loggedIn = false;

// --- DOM ---
const postsContainer = document.getElementById('posts');
const postCount = document.getElementById('postCount');
const loginStatus = document.getElementById('loginStatus');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const postText = document.getElementById('postText');
const postImage = document.getElementById('postImage');
const postBtn = document.getElementById('postBtn');

// --- Utils ---
function escapeHtml(s){if(!s)return'';return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
function hashPass(pw){return btoa(pw);}
function normalizePost(item){const id=item.id||(item.time?`${item.time}-${Math.random().toString(36).substr(2,5)}`:'p-'+Math.random().toString(36).substr(2,9));const time=item.time||new Date().toISOString();return {...item,id,time};}

// --- Load Feed ---
async function loadFeed(){
  try{
    const res = await fetch(FEED_URL,{cache:'no-store'});
    if(!res.ok) throw new Error(res.status);
    feedData = await res.json();
    renderPosts();
  }catch(e){
    console.warn('Error loading feed', e);
    feedData = {username:'',password:'',about:'',posts:[]};
  }
}

// --- Render Posts with simple algorithm ---
function renderPosts(){
  postsContainer.innerHTML='';
  if(!feedData || !feedData.posts || feedData.posts.length===0){postsContainer.innerHTML='<div>No posts yet.</div>';postCount.innerText='0';return;}
  // Algorithm: prioritize newer posts + random boost
  feedData.posts.sort((a,b)=>{
    const ageScore=(new Date(b.time)-new Date(a.time))/1000; // newer= higher
    const boost=Math.random()*50; // random small boost
    return (ageScore+boost)-(new Date(a.time)-new Date(b.time));
  });
  postCount.innerText=feedData.posts.length;
  feedData.posts.forEach(p=>{
    const el=document.createElement('div'); el.className='post';
    let html=`<div class='meta'>${escapeHtml(feedData.username)} â€¢ ${new Date(p.time).toLocaleString()}</div>`;
    html+=`<div>${escapeHtml(p.text)}</div>`;
    if(p.image) html+=`<img class='post-image' src='${p.image}'/>`;
    el.innerHTML=html;
    postsContainer.appendChild(el);
  });
}

// --- Login ---
document.getElementById('loginBtn').onclick = ()=>{
  const u=usernameInput.value.trim();
  const p=passwordInput.value.trim();
  if(!feedData){loginStatus.textContent='Feed not loaded';return;}
  if(u===feedData.username && hashPass(p)===feedData.password){
    loggedIn=true;
    loginStatus.style.color='green';
    loginStatus.textContent='Login successful';
    postText.disabled=false;
    postImage.disabled=false;
    postBtn.disabled=false;
  }else{
    loggedIn=false;
    loginStatus.style.color='red';
    loginStatus.textContent='Invalid username or password';
    postText.disabled=true;
    postImage.disabled=true;
    postBtn.disabled=true;
  }
};

// --- Post ---
postBtn.onclick = ()=>{
  if(!loggedIn) return alert('Login first');
  const text=postText.value.trim();
  if(!text) return;
  const newPost=normalizePost({text});
  const file = postImage.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e=>{
      newPost.image = e.target.result;
      feedData.posts.unshift(newPost);
      postText.value=''; postImage.value='';
      renderPosts();
    };
    reader.readAsDataURL(file);
  }else{
    newPost.image='';
    feedData.posts.unshift(newPost);
    postText.value='';
    renderPosts();
  }
};

// --- Export feed.json ---
document.getElementById('exportBtn').onclick = ()=>{
  if(!feedData) return;
  const dataStr = JSON.stringify(feedData,null,2);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([dataStr],{type:'application/json'}));
  a.download='feed.json';
  document.body.appendChild(a); a.click(); a.remove();
};

// --- Refresh manually ---
document.getElementById('refresh').onclick = ()=> loadFeed();

// --- Auto-refresh every 30s ---
setInterval(loadFeed,30000);

// --- Init ---
loadFeed();
</script>
</body>
</html>
