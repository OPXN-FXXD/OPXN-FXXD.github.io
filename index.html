<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OPENFEED — Prototype</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:#f6f8fa;color:#111}
    header{background:#0b5fff;color:white;padding:1rem 1.25rem}
    .container{max-width:980px;margin:1rem auto;padding:1rem;background:white;border-radius:8px;box-shadow:0 4px 16px rgba(11,95,255,0.08)}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:1rem}
    input,textarea,select,button{font:inherit}
    .card{padding:0.75rem;border:1px solid #e6e9ee;border-radius:6px}
    .message{border-bottom:1px solid #eee;padding:0.5rem 0}
    .muted{color:#6b7280;font-size:0.9rem}
    .actions{display:flex;gap:0.5rem;flex-wrap:wrap}
    .btn{background:#0b5fff;color:white;border:0;padding:0.5rem 0.75rem;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#f1f5f9;color:#0b5fff;border:1px solid #cfe0ff}
    .small{font-size:0.85rem;padding:0.25rem 0.5rem}
    footer{font-size:0.9rem;color:#6b7280;margin-top:1rem}
    .danger{color:#b91c1c}
  </style>
  <!-- bcryptjs CDN for client-side hashing (prototype only) -->
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
</head>
<body>
  <header>
    <h1 style="margin:0">OPENFEED — Prototype</h1>
    <div class="muted">Client-seitiges Demo: Profile exportieren als JSON (zum manuellen Upload auf GitHub). Siehe Hinweise unten.</div>
  </header>

  <div class="container">
    <div class="grid">
      <main>
        <section class="card">
          <h2>Anzeigen — Öffentliche Beiträge</h2>
          <div id="publicFeed"></div>
        </section>

        <section class="card" style="margin-top:1rem">
          <h2>Neuen Beitrag erstellen</h2>
          <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem">
            <input id="postRecipient" placeholder="Empfänger ("all" für Öffentlich)" style="flex:1;padding:0.5rem" value="all">
            <input id="postAuthor" placeholder="Ihr Profil-Name (eingeloggt ersetzt)" style="width:200px;padding:0.5rem">
          </div>
          <textarea id="postText" rows="4" placeholder="Was möchtest du posten?" style="width:100%;padding:0.5rem"></textarea>
          <div class="actions" style="margin-top:0.5rem">
            <button class="btn" id="btnPost">Posten</button>
            <button class="btn secondary" id="btnClear">Leeren</button>
          </div>
          <div id="postStatus" class="muted" style="margin-top:0.5rem"></div>
        </section>

      </main>

      <aside>
        <section class="card">
          <h3>Benutzer</h3>
          <div id="userBox"></div>
        </section>

        <section class="card" style="margin-top:1rem">
          <h3>Profile (lokal)</h3>
          <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem">
            <input id="newUser" placeholder="Benutzername" style="flex:1;padding:0.4rem">
          </div>
          <input id="newPwd" placeholder="Passwort" type="password" style="width:100%;padding:0.4rem;margin-top:0.4rem">
          <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
            <button class="btn small" id="btnCreate">Profil erstellen</button>
            <button class="btn secondary small" id="btnExport">Profil exportieren (JSON)</button>
          </div>
          <div style="margin-top:0.6rem">
            <input id="loginUser" placeholder="Benutzername zum Einloggen" style="width:100%;padding:0.4rem">
            <input id="loginPwd" placeholder="Passwort" type="password" style="width:100%;padding:0.4rem;margin-top:0.4rem">
            <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
              <button class="btn small" id="btnLogin">Einloggen</button>
              <button class="btn secondary small" id="btnLogout">Ausloggen</button>
            </div>
          </div>
        </section>

        <section class="card" style="margin-top:1rem">
          <h4>Hinweise & GitHub</h4>
          <p class="muted">Dieses Demo speichert Profile und Posts lokal (localStorage). Mit <strong>Profil exportieren</strong> erhältst du eine JSON-Datei, die du manuell in ein GitHub-Repo hochladen kannst (z. B. per Web-UI). Das Passwort wird clientseitig gehashed (bcrypt).</p>
          <p class="danger"><strong>Sicherheitshinweis:</strong> Öffentliche Speicherung von Profil-JSON (auch mit Hash) ist riskant. Für echte Nutzung brauchst du einen sicheren Server, HTTPS, serverseitiges Hashing, und eine echte API mit Auth-Token.</p>
        </section>

      </aside>
    </div>

    <footer>
      <strong>OPENFEED (Prototype)</strong> — Client-seitige Demo. Wenn du möchtest, kann ich die App erweitern: z.B. GitHub-API-Upload (braucht Token, am besten serverseitig), oder ein kleines Node.js Backend, das sichere Speicherung übernimmt.
    </footer>
  </div>

<script>
// Simple client-side OPENFEED prototype
// Data model (localStorage)
// profiles: { username: { hashedPassword, createdAt }}
// posts: [ {id, author, recipient, text, createdAt, public} ]

const LS_PROFILES = 'openfeed_profiles_v1';
const LS_POSTS = 'openfeed_posts_v1';

function loadProfiles(){
  return JSON.parse(localStorage.getItem(LS_PROFILES) || '{}');
}
function saveProfiles(p){
  localStorage.setItem(LS_PROFILES, JSON.stringify(p));
}
function loadPosts(){
  return JSON.parse(localStorage.getItem(LS_POSTS) || '[]');
}
function savePosts(posts){
  localStorage.setItem(LS_POSTS, JSON.stringify(posts));
}

function uid(){return Math.random().toString(36).slice(2,9)}

function renderPublicFeed(){
  const posts = loadPosts().filter(p=>p.public).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  const el = document.getElementById('publicFeed');
  el.innerHTML = '';
  if(!posts.length) el.innerHTML = '<div class="muted">Noch keine öffentlichen Beiträge.</div>';
  posts.forEach(p=>{
    const d = document.createElement('div'); d.className='message';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${escapeHtml(p.author||'anonym')}</strong><span class="muted">${new Date(p.createdAt).toLocaleString()}</span></div><div style="margin-top:0.4rem">${escapeHtml(p.text)}</div>`;
    el.appendChild(d);
  })
}

function renderUserBox(){
  const profiles = loadProfiles();
  const box = document.getElementById('userBox');
  const logged = sessionStorage.getItem('openfeed_logged') || null;
  box.innerHTML = '';
  if(logged){
    box.innerHTML = `<div>Eingeloggt als <strong>${escapeHtml(logged)}</strong></div><div style="margin-top:0.5rem" class="muted">Du siehst jetzt private Nachrichten und kannst unter deinem Namen posten.</div>`;
  } else {
    box.innerHTML = '<div class="muted">Nicht eingeloggt — nur öffentliche Beiträge sichtbar</div>';
  }
  const keys = Object.keys(profiles);
  if(keys.length){
    const list = document.createElement('div'); list.style.marginTop='0.6rem';
    list.innerHTML = '<strong>Bekannte Profile:</strong>';
    keys.forEach(k=>{ const it = document.createElement('div'); it.className='muted'; it.textContent = k; list.appendChild(it);});
    box.appendChild(list);
  }
}

function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

// Create profile -> hash with bcrypt
document.getElementById('btnCreate').addEventListener('click', async ()=>{
  const u = document.getElementById('newUser').value.trim();
  const pw = document.getElementById('newPwd').value;
  const status = document.getElementById('postStatus');
  if(!u || !pw){ status.textContent='Benutzername und Passwort erforderlich.'; return; }
  const profiles = loadProfiles();
  if(profiles[u]){ status.textContent='Benutzername existiert bereits (lokal).'; return; }
  status.textContent='Erstelle Profil...';
  // bcrypt hash, 10 rounds
  const salt = bcrypt.genSaltSync(10);
  const hash = bcrypt.hashSync(pw, salt);
  profiles[u] = { hashedPassword: hash, createdAt: new Date().toISOString() };
  saveProfiles(profiles);
  document.getElementById('newUser').value=''; document.getElementById('newPwd').value='';
  status.textContent='Profil erstellt (lokal). Klicke "Profil exportieren" um JSON zu erhalten.';
  renderUserBox();
});

// Export profile as JSON for manual upload to GitHub
document.getElementById('btnExport').addEventListener('click', ()=>{
  const name = prompt('Welches Profil exportieren? (Benutzername)');
  if(!name) return;
  const prof = loadProfiles()[name];
  if(!prof){ alert('Profil nicht gefunden (lokal)'); return; }
  const json = { username: name, hashedPassword: prof.hashedPassword, createdAt: prof.createdAt };
  const blob = new Blob([JSON.stringify(json, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${name}.openfeed.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// Login
document.getElementById('btnLogin').addEventListener('click', ()=>{
  const u = document.getElementById('loginUser').value.trim();
  const pw = document.getElementById('loginPwd').value;
  const profiles = loadProfiles();
  const status = document.getElementById('postStatus');
  if(!profiles[u]){ status.textContent='Profil nicht gefunden (lokal).'; return; }
  const ok = bcrypt.compareSync(pw, profiles[u].hashedPassword);
  if(ok){ sessionStorage.setItem('openfeed_logged', u); status.textContent='Eingeloggt.'; renderUserBox(); }
  else { status.textContent='Passwort falsch.'; }
});

// Logout
document.getElementById('btnLogout').addEventListener('click', ()=>{
  sessionStorage.removeItem('openfeed_logged'); document.getElementById('postStatus').textContent='Ausgeloggt.'; renderUserBox();
});

// Post
document.getElementById('btnPost').addEventListener('click', ()=>{
  const text = document.getElementById('postText').value.trim();
  const recipient = document.getElementById('postRecipient').value.trim() || 'all';
  const logged = sessionStorage.getItem('openfeed_logged');
  const authorInput = document.getElementById('postAuthor').value.trim();
  const author = logged || authorInput || 'anonym';
  const status = document.getElementById('postStatus');
  if(!text){ status.textContent='Text darf nicht leer sein.'; return; }
  const posts = loadPosts();
  const post = { id: uid(), author, recipient, text, createdAt: new Date().toISOString(), public: (recipient==='all') };
  posts.push(post); savePosts(posts);
  document.getElementById('postText').value=''; status.textContent='Gesendet.'; renderPublicFeed();
});

// Clear post
document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('postText').value=''; });

// Initial demo content
if(!localStorage.getItem(LS_POSTS)){
  savePosts([
    { id:uid(), author:'TxT_swiss', recipient:'all', text:'Willkommen bei OPENFEED – öffentliches Testposting.', createdAt:new Date().toISOString(), public:true }
  ]);
}

renderPublicFeed(); renderUserBox();

</script>
</body>
</html>
