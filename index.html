<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenFeed 8-Bit</title>
<style>
  body {
    font-family: "Press Start 2P", monospace;
    background:#111; color:#0f0;
    margin:0; padding:0;
    display:flex; flex-direction:column; align-items:center;
  }
  header { padding:10px; font-size:18px; text-align:center; }
  #container { width:90%; max-width:600px; margin-top:10px; }
  input, button, textarea { 
    font-family: monospace; 
    font-size:12px; 
    margin:2px 0; 
    padding:4px; 
    border:2px solid #0f0; 
    background:#111; color:#0f0; 
  }
  button { cursor:pointer; }
  #feed { margin-top:10px; border-top:2px solid #0f0; padding-top:5px; }
  .post { border-bottom:1px dashed #0f0; margin-bottom:5px; padding-bottom:3px; }
  @media(max-width:400px){ textarea { width:100%; } input { width:100%; } }
</style>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
</head>
<body>
<header>OpenFeed 8-Bit</header>
<div id="container">
  <div id="loginArea">
    <input id="username" placeholder="Benutzername"><br>
    <input id="passphrase" placeholder="Passphrase (optional)"><br>
    <button id="createBtn">Erstellen / Laden</button>
    <div id="loginMsg"></div>
  </div>

  <div id="postArea" style="display:none;">
    <textarea id="postText" rows="3" placeholder="Schreibe etwas..."></textarea><br>
    <button id="postBtn">Posten</button>
  </div>

  <div id="feed"></div>
</div>

<script>
const gun = Gun({ peers:['https://gun-manhattan.herokuapp.com/gun'] });
const posts = gun.get('openfeed_posts');

let user = null;

function showFeed(){
  posts.map().once(post=>{
    if(!post || !post.text) return;
    const id = post.id || Math.random().toString(36).slice(2,8);
    if(document.getElementById(id)) return; // schon da
    const div = document.createElement('div');
    div.id = id;
    div.className = 'post';
    div.textContent = (post.author||'anonym') + ": " + post.text;
    document.getElementById('feed').prepend(div);
  });
}

document.getElementById('createBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('username').value.trim();
  const pass = document.getElementById('passphrase').value.trim();
  if(!name){ document.getElementById('loginMsg').textContent="Benutzername nÃ¶tig"; return; }
  const pair = pass ? await SEA.pair(pass) : await SEA.pair();
  user = { username:name, pair };
  localStorage.setItem('openfeed_user', JSON.stringify({ username:name, pair }));
  document.getElementById('loginArea').style.display='none';
  document.getElementById('postArea').style.display='block';
  showFeed();
});

document.getElementById('postBtn').addEventListener('click', async ()=>{
  if(!user){ alert("Bitte erst erstellen"); return; }
  const text = document.getElementById('postText').value.trim();
  if(!text) return;
  const id = 'p'+Date.now()+Math.random().toString(36).slice(2,6);
  posts.get(id).put({ id, text, author:user.username, time:Date.now() });
  document.getElementById('postText').value='';
});

posts.map().on(()=> showFeed());

// auto load local user
const saved = localStorage.getItem('openfeed_user');
if(saved){
  try{
    const u = JSON.parse(saved); user=u;
    document.getElementById('loginArea').style.display='none';
    document.getElementById('postArea').style.display='block';
    showFeed();
  } catch(e){}
}
</script>
</body>
</html>
