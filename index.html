<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenFeed 8-Bit Full</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
body { margin:0; font-family:'Press Start 2P', monospace; background:#111; color:#0f0; display:flex; flex-direction:column; min-height:100vh; }
header { padding:10px; text-align:center; border-bottom:3px solid #0f0; font-size:14px; }
#container { flex:1; display:flex; flex-wrap:wrap; padding:5px; }
.column { padding:5px; box-sizing:border-box; }
.left, .right { width:25%; min-width:150px; }
.middle { width:50%; min-width:200px; }
input, textarea, button { font-family: monospace; font-size:10px; margin:2px 0; padding:4px; border:2px solid #0f0; background:#111; color:#0f0; }
button { cursor:pointer; }
#feed { border-top:2px solid #0f0; padding-top:5px; margin-top:5px; max-height:60vh; overflow:auto; }
.post { border-bottom:1px dashed #0f0; margin-bottom:4px; padding-bottom:2px; }
.like-btn { background:#111; color:#0f0; border:2px solid #0f0; cursor:pointer; font-size:10px; margin-top:2px; }
#messages { max-height:30vh; overflow:auto; border-top:1px solid #0f0; margin-top:5px; padding-top:2px; }
img { max-width:100%; margin-top:3px; }
@media(max-width:800px){ .left,.middle,.right{width:100%;} }
</style>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
</head>
<body>
<header>OpenFeed 8-Bit</header>
<div id="container">
  <!-- Left: Identity + Inbox -->
  <div class="column left">
    <h4>Account</h4>
    <div id="identityBox">
      <input id="username" placeholder="Benutzername"><br>
      <input id="passphrase" placeholder="Passphrase (optional)"><br>
      <button id="createBtn">Erstellen / Laden</button>
    </div>
    <div id="userInfo" style="display:none;"></div>
    <h4>Nachrichten</h4>
    <div id="messages"></div>
  </div>

  <!-- Middle: Feed -->
  <div class="column middle">
    <h4>Feed</h4>
    <div id="feed"></div>
  </div>

  <!-- Right: Posten -->
  <div class="column right">
    <h4>Posten</h4>
    <textarea id="postText" rows="4" placeholder="Schreibe etwas..."></textarea><br>
    <input type="file" id="postImage"><br>
    <button id="postBtn">Posten</button>
  </div>
</div>

<script>
const gun = Gun({ peers:['https://gun-manhattan.herokuapp.com/gun'] });
const posts = gun.get('openfeed_posts');
const messagesNode = gun.get('openfeed_messages');
let user = null;
const inboxStore = [];

// ---------------- Identity ----------------
document.getElementById('createBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('username').value.trim();
  const pass = document.getElementById('passphrase').value.trim();
  if(!name){ alert("Benutzername nötig"); return; }
  const pair = pass ? await SEA.pair(pass) : await SEA.pair();
  user = { username:name, pair };
  localStorage.setItem('openfeed_user', JSON.stringify({ username:name, pair }));
  document.getElementById('identityBox').style.display='none';
  document.getElementById('userInfo').style.display='block';
  renderUserInfo();
  watchInbox();
  showFeed();
});

function renderUserInfo(){
  if(!user) return;
  document.getElementById('userInfo').innerHTML = `Name: ${user.username}<br>Pub: ${user.pair.pub}`;
}

// Auto-load local user
const saved = localStorage.getItem('openfeed_user');
if(saved){
  try{
    const u = JSON.parse(saved); user=u;
    document.getElementById('identityBox').style.display='none';
    document.getElementById('userInfo').style.display='block';
    renderUserInfo();
    watchInbox();
    showFeed();
  } catch(e){}
}

// ---------------- Posting ----------------
document.getElementById('postBtn').addEventListener('click', async ()=>{
  if(!user){ alert("Bitte erst erstellen"); return; }
  const text = document.getElementById('postText').value.trim();
  const fileInput = document.getElementById('postImage');
  const id = 'p'+Date.now()+Math.random().toString(36).slice(2,6);
  const postObj = { id, author:user.username, text, time:Date.now(), likes:0 };
  
  if(fileInput.files.length>0){
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = function(e){
      postObj.image = e.target.result;
      posts.get(id).put(postObj);
    }
    reader.readAsDataURL(file);
  } else {
    posts.get(id).put(postObj);
  }
  
  document.getElementById('postText').value='';
  fileInput.value='';
});

// ---------------- Feed ----------------
function showFeed(){
  posts.map().on(post=>{
    if(!post || !post.id) return;
    if(document.getElementById(post.id)) return; // existiert
    const div = document.createElement('div');
    div.className='post'; div.id=post.id;
    let html = `${post.author}: ${post.text}<br>`;
    if(post.image) html += `<img src="${post.image}">`;
    html += `<button class="like-btn" data-id="${post.id}">❤ ${post.likes||0}</button>`;
    div.innerHTML = html;
    document.getElementById('feed').prepend(div);

    // Like Button
    div.querySelector('button').addEventListener('click', ()=>{
      if(!user) return alert("Bitte einloggen");
      posts.get(post.id).get('likes').once(l=>{
        const newLikes = (l||0)+1;
        posts.get(post.id).get('likes').put(newLikes);
        div.querySelector('button').textContent = `❤ ${newLikes}`;
      });
    });
  });
}

// ---------------- Inbox ----------------
async function watchInbox(){
  if(!user) return;
  messagesNode.get(user.pair.pub).map().on(async msg=>{
    if(!msg || !msg.payload) return;
    try{
      const secret = await SEA.secret(msg.fromPub, user.pair);
      const text = await SEA.decrypt(msg.payload, secret);
      if(text && !inboxStore.find(x=>x.id===msg.id)){
        inboxStore.push({id:msg.id, from:msg.from, text});
        renderInbox();
      }
    } catch(e){ console.error(e); }
  });
}

function renderInbox(){
  const box = document.getElementById('messages');
  box.innerHTML='';
  inboxStore.sort((a,b)=>b.time - a.time).forEach(m=>{
    const div = document.createElement('div');
    div.innerHTML = `${m.from}: ${m.text}`;
    box.appendChild(div);
  });
}
</script>
</body>
</html>
