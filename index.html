<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OpenFeed — Advanced Dark Mode</title>
<style>
body {background:#121212; color:#eee; font-family:system-ui,sans-serif; margin:0; padding:16px;}
header {display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;}
h1 {margin:0; font-size:1.8rem;}
#clock {font-size:1rem; color:#aaa;}
input,textarea,button {font:inherit; padding:6px; border-radius:4px; border:1px solid #444; background:#1e1e1e; color:#eee;}
button {cursor:pointer; background:#333; color:#eee;}
button:hover {background:#555;}
.card {background:#1e1e1e; padding:16px; border-radius:10px; margin:16px 0; box-shadow:0 2px 5px rgba(0,0,0,0.5);}
.posts {max-height:600px; overflow-y:auto; padding:12px; border-radius:8px; background:#222; border:1px solid #444;}
.post {padding:12px; margin-bottom:12px; border-bottom:1px dashed #555; border-radius:6px; background:#2a2a2a;}
.meta {font-size:12px; color:#aaa; margin-bottom:6px;}
.post-image {max-width:100%; margin-top:6px; border-radius:6px;}
.controls {display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;}
.right {margin-left:auto; color:#aaa;}
.like-btn {background:#444; color:#eee; padding:4px 8px; border-radius:4px; cursor:pointer;}
.like-btn:hover {background:#666;}
#drop-area {border:2px dashed #555; padding:20px; text-align:center; margin-top:8px; border-radius:6px; color:#aaa;}
#drop-area.dragover {border-color:#888; color:#fff;}
</style>
</head>
<body>

<header>
<h1>OpenFeed Dark Mode</h1>
<div id="clock"></div>
</header>

<section class="card">
<h3>Feed Timeline</h3>
<div class="controls">
<button id="refresh">Refresh Now</button>
<div class="right">Posts: <span id="postCount">0</span></div>
</div>
<div class="posts" id="posts"></div>
</section>

<section class="card">
<h3>Login to Post</h3>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
<p id="loginStatus" style="color:red;"></p>
</section>

<section class="card">
<h3>New Post</h3>
<textarea id="postText" rows="3" placeholder="Write your post..." disabled></textarea>
<div id="drop-area">Drag & Drop image here (optional)</div>
<div class="controls">
<button id="postBtn" disabled>Post</button>
<button id="exportBtn">Download feed.json</button>
</div>
</section>

<script>
// --- Config ---
const FEED_URL = "https://OPXN-FXXD.github.io/feed.json";
let feedData = null;
let loggedIn = false;
let dragImage = null;
let viewedPosts = new Set();

// --- DOM ---
const postsContainer = document.getElementById('posts');
const postCount = document.getElementById('postCount');
const loginStatus = document.getElementById('loginStatus');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const postText = document.getElementById('postText');
const postBtn = document.getElementById('postBtn');
const dropArea = document.getElementById('drop-area');
const clockElem = document.getElementById('clock');

// --- Utils ---
function escapeHtml(s){if(!s)return '';return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
function hashPass(pw){return btoa(pw);}
function normalizePost(item){const id=item.id||(item.time?`${item.time}-${Math.random().toString(36).substr(2,5)}`:'p-'+Math.random().toString(36).substr(2,9));const time=item.time||new Date().toISOString();return {...item,id,time,likes:0,views:0,image:item.image||null};}

// --- Clock ---
function updateClock(){const now=new Date(); clockElem.textContent=now.toLocaleTimeString();}
setInterval(updateClock,1000); updateClock();

// --- Load Feed ---
async function loadFeed(){
  try{
    const res = await fetch(FEED_URL,{cache:'no-store'});
    if(res.ok){
      feedData = await res.json();
      renderPosts();
    }else{
      feedData = {username:'',password:'',about:'',posts:[]};
    }
  }catch(e){
    console.warn('Error loading feed', e);
    feedData = {username:'',password:'',about:'',posts:[]};
  }
}

// --- Render Posts ---
function renderPosts(){
  postsContainer.innerHTML='';
  if(!feedData || !feedData.posts || feedData.posts.length===0){postsContainer.innerHTML='<div>No posts yet.</div>'; postCount.innerText='0'; return;}
  const now = new Date();
  feedData.posts.forEach(p=>{
    if(!viewedPosts.has(p.id)){p.views=(p.views||0)+1; viewedPosts.add(p.id);}
    const ageHours = (now - new Date(p.time))/(1000*60*60);
    p.displayScore = (p.likes||0 +1) - ageHours/24 + Math.random()*0.5;
  });
  feedData.posts.sort((a,b)=>b.displayScore - a.displayScore);
  postCount.innerText=feedData.posts.length;

  feedData.posts.forEach(p=>{
    const el=document.createElement('div'); el.className='post';
    let html=`<div class='meta'>${escapeHtml(feedData.username)} • ${new Date(p.time).toLocaleString()} • Likes: ${p.likes} • Views: ${p.views}</div>`;
    html+=`<div>${escapeHtml(p.text)}</div>`;
    if(p.image) html+=`<img class='post-image' src='${p.image}'>`;
    if(loggedIn) html+=`<button class='like-btn' data-id='${p.id}'>Like</button>`;
    el.innerHTML=html;
    postsContainer.appendChild(el);
  });

  // Like button handler
  document.querySelectorAll('.like-btn').forEach(btn=>{
    btn.onclick=()=>{
      const pid = btn.getAttribute('data-id');
      const post = feedData.posts.find(p=>p.id===pid);
      if(post){post.likes=(post.likes||0)+1; renderPosts();}
    };
  });
}

// --- Login ---
document.getElementById('loginBtn').onclick=()=>{
  const u=usernameInput.value.trim();
  const p=passwordInput.value.trim();
  if(!feedData){loginStatus.textContent='Feed not loaded'; return;}
  if(u===feedData.username && hashPass(p)===feedData.password){
    loggedIn=true; loginStatus.style.color='lightgreen'; loginStatus.textContent='Login successful';
    postText.disabled=false; postBtn.disabled=false;
  }else{
    loggedIn=false; loginStatus.style.color='red'; loginStatus.textContent='Invalid username or password';
    postText.disabled=true; postBtn.disabled=true;
  }
};

// --- Post ---
postBtn.onclick=()=>{
  if(!loggedIn) return alert('Login first');
  const text = postText.value.trim(); if(!text) return;
  const newPost = normalizePost({text,image:dragImage});
  feedData.posts.unshift(newPost);
  postText.value=''; dragImage=null; dropArea.textContent='Drag & Drop image here (optional)';
  renderPosts();
};

// --- Drag & Drop ---
dropArea.addEventListener('dragover', e=>{e.preventDefault(); dropArea.classList.add('dragover');});
dropArea.addEventListener('dragleave', e=>{e.preventDefault(); dropArea.classList.remove('dragover');});
dropArea.addEventListener('drop', e=>{
  e.preventDefault(); dropArea.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if(file && file.type.startsWith('image/')){
    const reader = new FileReader();
    reader.onload = ev=>{dragImage = ev.target.result; dropArea.textContent='Image ready';}
    reader.readAsDataURL(file);
  }else{dropArea.textContent='Invalid file';}
});

// --- Export feed.json ---
document.getElementById('exportBtn').onclick=()=>{
  if(!feedData) return;
  const dataStr = JSON.stringify(feedData,null,2);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([dataStr],{type:'application/json'}));
  a.download='feed.json'; document.body.appendChild(a); a.click(); a.remove();
};

// --- Refresh ---
document.getElementById('refresh').onclick=()=>loadFeed();
setInterval(loadFeed,30000);

// --- Init ---
loadFeed();
</script>
</body>
</html>
